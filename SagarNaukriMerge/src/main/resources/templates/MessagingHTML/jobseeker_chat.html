<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .chat-box { height: 60vh; overflow-y: scroll; border: 1px solid #e0e0e0; padding: 1rem; background-color: #f9f9f9; border-radius: .5rem; }
    .message { padding: 8px 14px; border-radius: 18px; margin-bottom: 10px; max-width: 70%; word-wrap: break-word; }
    .sent { background-color: #0d6efd; color: white; margin-left: auto; text-align: right; }
    .received { background-color: #e9ecef; color: black; margin-right: auto; }
    .message small { font-size: 0.75rem; display: block; margin-top: 4px; opacity: 0.8; }
  </style>
</head>
<body>
<div th:insert="~{JobSeekerHTML/headerfragment :: siteheader(${jobSeeker})}"></div>

<div class="container my-4">
  <div class="card shadow-sm">
    <div class="card-header bg-white">
      <h4 class="mb-0">
        <span th:if="${company != null}" th:text="'Chat with ' + ${company.companyname}"></span>
        <span th:unless="${company != null}">
                    Chat with <span th:each="participant : ${otherJobSeekers}" th:text="${participant.name}"></span>
                </span>
      </h4>
    </div>
    <div class="card-body">
      <div class="chat-box mb-3" id="chatBox">
        <div th:each="msg : ${messages}">
          <div class="message" th:classappend="${msg.senderType == 'JOBSEEKER'} ? 'sent' : 'received'">
            <strong th:text="${msg.senderType == 'JOBSEEKER' ? jobSeeker.name : company.companyname}">Sender:</strong>
            <p th:text="${msg.content}" class="mb-0"></p>
            <small th:text="${#temporals.format(msg.timestamp, 'dd-MMM hh:mm a')}"></small>
          </div>
        </div>
      </div>

      <form id="messageForm" class="input-group">
        <input type="hidden" name="conversationId" th:value="${conversation.id}" />
        <input type="text" id="messageInput" class="form-control" placeholder="Type a reply..." required autofocus>
        <button type="submit" class="btn btn-primary">Send</button>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script th:inline="javascript">
  // Get data passed from the Spring Boot Model
  const conversationId = /*[[${conversation.id}]]*/ 'default';

  // KEY CHANGE: The loggedInUser is now the JobSeeker
  const loggedInUser = {
      id: /*[[${jobSeeker.JSId}]]*/ 'default',
      name: /*[[${jobSeeker.name}]]*/ 'default',
      type: 'JOBSEEKER'
  };

  // KEY CHANGE: The otherParticipant is now the Company
  const otherParticipant = {
      name: /*[[${company != null ? company.companyname : ''}]]*/ 'default'
  };

  let stompClient = null;
  const chatBox = document.getElementById('chatBox');
  const messageForm = document.getElementById('messageForm');
  const messageInput = document.getElementById('messageInput');

  function connect() {
      const socket = new SockJS('/ws');
      stompClient = Stomp.over(socket);
      stompClient.connect({}, onConnected, onError);
  }

  function onConnected() {
      console.log('Connected to WebSocket!');
      stompClient.subscribe('/topic/messages/' + conversationId, onMessageReceived);
  }

  function onError(error) {
      console.error('Could not connect to WebSocket server.');
  }

  function onMessageReceived(payload) {
      const message = JSON.parse(payload.body);
      const messageElement = document.createElement('div');
      messageElement.classList.add('message');

      if (message.senderType === loggedInUser.type) {
          messageElement.classList.add('sent');
      } else {
          messageElement.classList.add('received');
      }

      const senderName = message.senderType === 'JOBSEEKER' ? loggedInUser.name : otherParticipant.name;

      messageElement.innerHTML = `
          <strong>${senderName}:</strong>
          <p class="mb-0">${message.content}</p>
          <small class="text-muted d-block text-end">${new Date(message.timestamp).toLocaleTimeString()}</small>
      `;

      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
  }

  function sendMessage(event) {
      event.preventDefault();
      const messageContent = messageInput.value.trim();

      if (messageContent && stompClient) {
          const chatMessage = {
              senderId: loggedInUser.id,
              senderType: loggedInUser.type,
              content: messageInput.value
          };
          stompClient.send("/app/chat/" + conversationId, {}, JSON.stringify(chatMessage));
          messageInput.value = '';
      }
  }

  connect();
  messageForm.addEventListener('submit', sendMessage, true);
  window.onload = () => { chatBox.scrollTop = chatBox.scrollHeight; };
</script>

</body>
</html>